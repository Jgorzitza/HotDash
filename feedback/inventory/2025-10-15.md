# Inventory Agent Feedback — 2025-10-15

## Startup Checklist Execution

### 0) Align to the Star ✅
- Reviewed `docs/NORTH_STAR.md` — Vision clear: trustworthy operator-first control center
- Key inventory scope from NORTH_STAR:
  - ROP + safety stock suggestions
  - Kits/bundles via `BUNDLE:TRUE`
  - Picker piece counts via `PACK:X`
  - Picker payout brackets
  - Status buckets: in_stock, low_stock, out_of_stock, urgent_reorder
- Reviewed `docs/OPERATING_MODEL.md` and `docs/RULES.md`

### 1) Direction & Issue ⚠️
- **Direction file status:** `docs/directions/inventory.md` shows "NOT ACTIVE" — Milestone M3
- **User activation:** User has explicitly activated me with specific tasks
- **Tasks assigned:**
  1. Create inventory data model spec including ROP formula, kit/bundle structure, picker payout logic
  2. Research and document Shopify inventory metafields (BUNDLE:TRUE, PACK:X, lead time, safety stock)
- **Branch:** `agent/inventory/data-model-prep`
- **Scope:** Spec and research only - no implementation yet
- **Coordination:** Work with data agent for schema design

**Note:** Direction file says NOT ACTIVE but user has explicitly activated me with clear tasks. Proceeding with user's direct instruction.

### 2) Tools & Env
- Need to verify MCP tools (Shopify, Supabase)
- Will test after branch setup

### 3) Sandbox & Branch
- Current branch: `agent/ai-customer/openai-sdk-foundation` (not mine)
- Need to create: `agent/inventory/data-model-prep`
- Allowed paths (inferred from task):
  - `docs/specs/inventory_*.md`
  - `docs/integrations/shopify_inventory_metafields.md`
  - `feedback/inventory/*.md`

## Today's Plan

### Phase 1: Research (60-90 min)
1. Use Shopify MCP to research inventory metafields structure
2. Review Shopify Admin GraphQL inventory schema
3. Document metafield patterns for BUNDLE:TRUE, PACK:X, lead time, safety stock

### Phase 2: Spec Creation (90-120 min)
1. Create `docs/specs/inventory_data_model.md` with:
   - ROP formula (lead-time demand + safety stock)
   - Kit/bundle structure
   - Picker payout logic
   - Status bucket definitions
   - Metafield mappings
2. Create `docs/integrations/shopify_inventory_metafields.md` with research findings

### Phase 3: Coordination
1. Document schema requirements for data agent
2. Note any blockers or questions

## Next Actions
- Create branch `agent/inventory/data-model-prep` ✅
- Verify MCP tools (Shopify, Supabase)
- Begin Shopify inventory metafields research

---

## Research Phase — Shopify Inventory & Metafields

### Existing Codebase Findings

**Inventory Query Implementation** (`app/services/shopify/inventory.ts`):
- ✅ Uses current 2024+ API: `quantities(names: ["available"])`
- ✅ Queries: `productVariants`, `inventoryItem`, `inventoryLevels`
- ✅ Fields: `id`, `title`, `sku`, `inventoryQuantity`, `product.title`
- ✅ Computes available quantity across locations
- ✅ Estimates days of cover: `quantity / averageDailySales`

**Existing Spec** (`docs/specs/inventory_spec.md`):
- ✅ ROP formula documented: `avg_daily_sales * lead_time_days + safety_stock`
- ✅ Safety stock formula: `(max_daily_sales * max_lead_days) - (avg_daily_sales * avg_lead_days)`
- ✅ Status buckets: `in_stock`, `low_stock`, `out_of_stock`, `urgent_reorder`
- ✅ Kits/bundles: Detect via `BUNDLE:TRUE` tag
- ✅ Picker piece counts: `PACK:X` tag

**Data Contracts** (`docs/data/data_contracts.md`):
- ✅ Fact type: `shopify.inventory.coverage`
- ✅ Required fields defined for inventory queries

### Metafields Research Needed

**Questions to answer:**
1. How to structure metafields for lead time and safety stock?
2. Shopify metafield namespace conventions?
3. How to query metafields in GraphQL?
4. How to handle kit/bundle component relationships?
5. Picker payout bracket structure?

**Next:** Research Shopify metafields API and structure

### Shopify Metafields Research Complete ✅

**Key Findings:**

1. **Metafield Structure:**
   - Identifier: `namespace` + `key` (e.g., `custom.lead_time_days`)
   - Value: Always stored as string (regardless of type)
   - Type: Enforces validation (e.g., `number_integer`, `boolean`)
   - Definition: Optional but recommended for consistency

2. **Relevant Metafield Types for Inventory:**
   - `number_integer` - For lead time days, safety stock quantity, pack count
   - `number_decimal` - For costs, weights
   - `boolean` - For BUNDLE:TRUE flag
   - `single_line_text_field` - For simple text values
   - `date` - For expected restock dates

3. **GraphQL Query Pattern:**
```graphql
product {
  metafield(namespace: "custom", key: "lead_time_days") {
    value
    type
  }
}
```

4. **Namespace Conventions:**
   - `custom.*` - For merchant-managed fields
   - `app.*` - For app-specific fields (our use case)
   - Recommendation: Use `app.inventory` namespace

5. **Proposed Metafield Structure:**
   - `app.inventory.lead_time_days` (number_integer)
   - `app.inventory.safety_stock` (number_integer)
   - `app.inventory.is_bundle` (boolean)
   - `app.inventory.pack_count` (number_integer)
   - `app.inventory.picker_payout_rate` (number_decimal)

**Next:** Create comprehensive spec documents

---

## Spec Creation Complete ✅

### Documents Created

1. **`docs/specs/inventory_data_model.md`** (300 lines)
   - Complete ROP formula with examples
   - Status bucket definitions and logic
   - Kit/bundle structure (tag-based and metafield-based)
   - Picker payout logic with brackets
   - Shopify metafield mappings
   - Data flow and integration patterns
   - Coordination requirements for data agent

2. **`docs/integrations/shopify_inventory_metafields.md`** (300 lines)
   - Metafields fundamentals and concepts
   - Namespace conventions (`app.inventory`)
   - Proposed metafield schema (8 core fields)
   - Complete GraphQL query examples
   - Mutation examples (create, update, delete)
   - Metafield definition creation
   - Tag-based fallback strategy
   - Implementation checklist
   - Best practices

### Key Deliverables

**ROP Formula:**
```
ROP = (Average Daily Sales × Lead Time Days) + Safety Stock
```

**Status Buckets:**
- `in_stock`: Quantity > ROP
- `low_stock`: ROP ≥ Quantity > (ROP × 0.5)
- `urgent_reorder`: (ROP × 0.5) ≥ Quantity > 0
- `out_of_stock`: Quantity = 0

**Bundle Detection:**
- Tag: `BUNDLE:TRUE`
- Metafield: `app.inventory.is_bundle` (boolean)

**Pack Count:**
- Tag: `PACK:X`
- Metafield: `app.inventory.pack_count` (number_integer)

**Picker Payout:**
- Pieces = Order Quantity × Pack Count
- Brackets: $0.10 (1-100), $0.12 (101-500), $0.15 (501-1000), $0.18 (1001+)

**Metafield Namespace:**
- `app.inventory.*` for all inventory fields
- 8 core metafields defined (lead_time_days, safety_stock, is_bundle, pack_count, etc.)

### Coordination Notes for Data Agent

**Required Supabase Tables:**
1. `products` - Product master with metafield values
2. `inventory_snapshots` - Point-in-time inventory + calculations
3. `sales_velocity` - Historical sales for ROP
4. `picker_payouts` - Payout summary
5. `picker_payout_lines` - Line item detail
6. `reorder_suggestions` - Generated PO recommendations

**Schema Requirements:**
- Typed columns (not JSON blobs) for metafield values
- Indexes on: sku, status_bucket, rop, available_quantity
- Timestamps: created_at, updated_at
- Foreign keys for referential integrity

### Next Steps

1. **Data Agent:** Design Supabase schema based on spec
2. **Integrations Agent:** Implement metafield sync job
3. **Engineer Agent:** Build inventory heatmap UI
4. **Inventory Agent (Future):** Implement ROP calculation service

### Blockers

None. Spec and research complete. Ready for handoff to data agent.

### Questions for Manager

1. Should we implement bracket-based or flat-rate picker payout initially?
2. Should bundle component tracking (Option 2) be in initial scope or future enhancement?
3. Priority: Metafield definitions creation before or after schema design?

---

## Summary

**Time Spent:** ~90 minutes
**Status:** ✅ Complete - Spec and Research Phase
**Deliverables:**
- Comprehensive data model spec (300 lines)
- Shopify metafields integration guide (300 lines)
- Research findings documented
- Coordination requirements defined

**Branch:** `agent/inventory/data-model-prep`
**Files Created:**
- `docs/specs/inventory_data_model.md`
- `docs/integrations/shopify_inventory_metafields.md`
- `feedback/inventory/2025-10-15.md`

**Ready for:** Data agent schema design and implementation planning

