# Direction Archive — data — 2025-10-16

Source: docs/directions/data.md (archived daily objective)

## 15) Today's Objective (2025-10-16) — BLOCKER‑FIRST RESET

Status: ACTIVE
Priority: P0 — Restore approvals/audit foundation and unblock UI/API

Work rule: Execute strictly in order. If blocked >10 minutes, log the blocker in feedback/data/<today>.md and move to the next task.

Git Process (Manager‑Controlled)

- Do not run git; Manager will create Issues/PRs with Allowed paths/DoD.

Ordered Task List (30)

1. Recreate 20251015_approvals_workflow.sql (approvals, approval_items, approval_grades, approval_edits)
2. Recreate 20251015_approvals_workflow.rollback.sql (drop in reverse order)
3. Recreate 20251015_audit_logs.sql (immutable audit_logs with append‑only trigger)
4. Recreate 20251015_audit_logs.rollback.sql
5. RLS policies for approvals/\* and audit_logs (service_role full; anon/auth read as appropriate)
6. Seed data for approvals to enable UI demos (5 approvals, mixed states)
7. RPC get_approvals_list(filters, paging)
8. RPC get_approvals_queue_tile()
9. docs/specs/approvals_schema.md (columns, RLS, RPCs, examples)
10. docs/specs/audit_schema.md (triggers, retention, examples)
11. Indexes for RPC paths (<100ms target)
12. Nightly rollup job for approvals metrics
13. /validate SQL prerequisites note for Engineer (what Drawer blocks on)
14. Rollback verification notes (apply/down plan)
15. growth_metrics_daily sanity checks (unchanged if present)
16. cx_metrics_daily sanity checks
17. Ensure picker_payouts exists and has RLS
18. RPC get_stock_risk_tile()
19. RPC get_cx_queue_tile()
20. Audit triggers on approvals tables (insert/update)
21. Backfill minimal dev data (demo)
22. EXPLAIN ANALYZE key queries; optimize
23. Add test harness SQL for RPCs
24. Document migration order & dependencies
25. Coordinate with Integrations on Supabase client usage
26. Provide sample tile queries to Engineer
27. Deliver rollbacks for all new files
28. Update feedback with evidence & timings
29. Notify Engineer on RPC readiness
30. Hand off guardrail notes to Manager (PR checklist)

Current Focus: Tasks 1–5, then 6–9
Blockers: None — proceed with schema/docs first, then RPCs.
Critical: All migrations must be reversible; RLS enforced; P95 read <100ms.

### Artifact Source and Phase 2 — NORTH_STAR Delivery (22 tasks)

Note: Manager will restore SQL and docs from docs/\_archive/2025-10-15-prebundle/supabase and /docs. Agents must not use git. Validate and proceed.

Phase 2 Tasks:

1. Partitioning strategy review for approvals/audit tables
2. Add retention policy and archive job for audit_logs
3. Add dedupe constraints on approval_items
4. Add NOTIFY channels for approvals events
5. Create pub/sub function for UI live updates
6. Add sampling tables for telemetry
7. Strengthen RLS with USING/WITH CHECK examples
8. Create security labels and mask views where needed
9. Add view for dashboard tile aggregates
10. Incremental materialized view refresh strategy
11. Add dead-letter queue for failed RPC jobs (notes)
12. Add EXPLAIN ANALYZE docs with thresholds
13. Benchmarks against 100k approvals rows
14. Add seeding scripts for QA replay
15. Add rollback drill documentation
16. Add index maintenance guidance
17. Add foreign keys and cascading rules audit
18. Add consistency checks (triggers)
19. Add soft-delete pattern for approvals if needed
20. Add audit diff function for edits
21. Add PR checklist for DB changes (evidence + rollback)
22. Hand off API contracts examples to Engineer/QA
