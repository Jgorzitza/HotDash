---
epoch: 2025.10.E1
doc: docs/compliance/data_inventory.md
owner: compliance
last_reviewed: 2025-10-13
doc_hash: TBD
expires: 2025-10-14
---

# Data Inventory & Retention Matrix — Operator Control Center

## Scope & Methodology

- Systems in scope: Shopify Admin app (React Router 7), Prisma (SQLite/Postgres), Supabase Memory, Chatwoot, Google Analytics MCP, OpenAI API (planned for AI assistance), LlamaIndex ingestion service, operator decision/fact pipelines, in-app caches.
- Sources: Service implementations under `app/services`, contract specs in `docs/data/data_contracts.md`, and runbooks/governance documents referenced in the compliance canon.
- Classification: Mark data elements containing personal data (PD), sensitive personal data (SPD), or confidential business data (CBD). Absence of classification indicates operational metadata only. `PD` = personal data, `SPD` = special category personal data, `CBD` = confidential business data.

---

## Summary Matrix

| Processing Activity                      | Source / Interface                                                                     | Data Categories                                                                                                                                              | Storage Location(s)                                                                                                   | Retention Target                                                                               | Purpose & Legal Basis                                                                | Access Controls                                                                                                   | Notes / Gaps                                                                                                                                                |
| ---------------------------------------- | -------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------ | --------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------ | ----------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Shopify OAuth Session Mgmt               | Shopify Admin OAuth callbacks via `@shopify/shopify-app-session-storage-prisma`        | Shop domain (CBD), access token (confidential), operator email/first/last name (PD), collaborator flag (PD)                                                  | Prisma `Session` table (`prisma/schema.prisma`)                                                                       | 90 days                                                                                        | Maintain authenticated session (contractual necessity with merchant)                 | Prisma access from app server; no Supabase replication                                                            | Purge job removes expired/90+ day sessions (`docs/compliance/evidence/retention_runs/2025-10-15_purge_log.json`); monitor deletion counts in weekly review. |
| Sales Pulse Tile                         | Shopify Admin GraphQL `SalesPulse` query                                               | Order id/name (CBD), createdAt, fulfillment status, financial status, SKU + revenue aggregates (CBD)                                                         | Prisma `DashboardFact` (`factType=shopify.sales.summary`); in-memory cache (TTL via `app/services/shopify/orders.ts`) | 30 days                                                                                        | Provide sales overview to operators (legitimate interest / contractual)              | App service only; Supabase facts not used                                                                         | 30-day purge job executed 2025-10-10; log stored at `docs/compliance/evidence/retention_runs/2025-10-15_purge_log.json`.                                    |
| Fulfillment Issues Tile                  | Shopify Admin GraphQL `ORDER_FULFILLMENTS_QUERY`                                       | Order id/name (CBD), display status, createdAt timestamps                                                                                                    | Prisma `DashboardFact` (`factType=shopify.fulfillment.issues`)                                                        | 30 days                                                                                        | Highlight fulfillment blockers (contractual)                                         | App service; cached in memory                                                                                     | Covered by same purge run (`docs/compliance/evidence/retention_runs/2025-10-15_purge_log.json`); monitor deletion counts weekly.                            |
| Inventory Heatmap Tile                   | Shopify Admin GraphQL `InventoryLevels`                                                | Variant id, SKU (CBD), product title, inventoryQuantity (CBD)                                                                                                | Prisma `DashboardFact` (`factType=shopify.inventory.health`)                                                          | 30 days                                                                                        | Prevent stockouts (contractual)                                                      | App service only                                                                                                  | Purge automation validated 2025-10-10 (see `docs/compliance/evidence/retention_runs/2025-10-15_purge_log.json`); continue clamping negatives.               |
| CX Escalations Tile                      | Chatwoot REST `/conversations` + `/messages`                                           | Conversation id, inbox id (CBD), customer name (PD), tags, message transcript excerpts (PD)                                                                  | Prisma `DashboardFact` (`factType=chatwoot.escalations`); cached in-memory (`CACHE_TTL_MS` env)                       | 14 days                                                                                        | Surface SLA breaches and recommended actions (legitimate interest / contractual)     | App service; no Supabase replication                                                                              | Included in purge job (see `docs/compliance/evidence/retention_runs/2025-10-15_purge_log.json`); continue transcript masking review.                        |
| Operator Actions on CX Escalations       | HotDash action `/actions/chatwoot.escalate`                                            | Conversation id (CBD), reply body (PD possible), operator note (PD possible), AI suggestion metadata (OpenAI draft id, prompt fingerprint), actor email (PD) | Prisma `DecisionLog`; Supabase `decision_log` mirror via `logDecision`; payload JSON persisted                        | 1 year (audit requirement); rotate Supabase service key per `docs/runbooks/secret_rotation.md` | Maintain audit trail for approvals (legal obligation / contractual)                  | Prisma + Supabase service key (least privilege); decisions accessible via internal tooling only                   | Need documented purge process post-retention; Supabase table currently unlimited.                                                                           |
| Dashboard Analytics Tracking             | App logs via `logDashboardView`/`logDashboardRefresh`                                  | Operator email (PD), requestId (CBD), tile identifier, timestamps                                                                                            | Supabase `facts` table (`topic=dashboard.analytics`); in-memory fallback if Supabase absent                           | 180 days (support trend analysis)                                                              | Measure operator engagement (legitimate interest, requires notice/consent)           | Supabase service key write; read limited to analytics tooling                                                     | Add opt-out toggle and update privacy notice before production.                                                                                             |
| GA Landing Page Anomalies                | GA MCP `/landing-pages` (planned)                                                      | Landing page URL path (CBD), session counts, WoW deltas                                                                                                      | Prisma `DashboardFact` (`factType=ga.sessions.anomalies`)                                                             | 30 days                                                                                        | Identify SEO/traffic issues (legitimate interest)                                    | App-only access                                                                                                   | GA MCP contract still pending; retention purge job already covers GA facts (see `docs/compliance/evidence/retention_runs/2025-10-15_purge_log.json`).       |
| Decision Log (non-Chatwoot)              | Various approval flows (future tiles)                                                  | Actor identifier/email (PD), action summary, rationale, optional evidence URL                                                                                | Prisma `DecisionLog`; Supabase `decision_log` mirror                                                                  | 1 year                                                                                         | Central audit log for operator actions (legal obligation)                            | As above                                                                                                          | Need DPIA once additional tiles ship.                                                                                                                       |
| In-app Cache Layer                       | Node memory via `app/services/cache.server.ts`                                         | Cached API responses (data listed above)                                                                                                                     | Process memory (no disk)                                                                                              | <=5 minutes TTL                                                                                | Reduce vendor calls (legitimate interest)                                            | Resets on deploy                                                                                                  | No additional controls required; document in DPIA.                                                                                                          |
| Knowledge Ingestion Graph                | `scripts/ai/build-llama-index.ts` (LlamaIndex crawler over docs/runbooks/support FAQs) | Document URLs (CBD), headings (CBD), chunked text (CBD), potential operator names in authored materials (PD)                                                 | Local vector index `packages/memory/indexes/operator_knowledge/` (metadata + embeddings)                              | 90 days (full rebuild wipes snapshot)                                                          | Provide retrieval context for AI suggestions (legitimate interest)                   | Access limited to AI/engineering service accounts; no external replication                                        | Build script purges directory before regeneration; archive hash + metadata in evidence when moving to shared storage.                                       |
| AI Recommendation Logs                   | `scripts/ai/log-recommendation.ts` (build pipeline)                                    | Case id (CBD), regression summary (CBD), AI input/output excerpts (PD possible if transcripts leak), git SHA (CBD)                                           | Local filesystem `packages/memory/logs/build/` (`decisions.ndjson` + per-run JSON)                                    | 30 days (retain latest 4 build cycles)                                                         | Preserve audit trail for AI-generated content (legitimate interest / accountability) | Access limited to AI/engineering; do not commit to repo history; future storage must be encrypted artifact bucket | Manual purge run logged in `docs/compliance/evidence/ai_logging/purge_run_2025-10-15.json`; integrate pre-run cleanup into pipeline + redact PII.           |
| Planned: Hootsuite Social Sentiment Tile | Hootsuite API (future)                                                                 | Sentiment score aggregates (CBD), campaign tags (CBD), social handle (PD if present)                                                                         | Not yet implemented                                                                                                   | 30 days (pre-launch target)                                                                    | Marketing insights (legitimate interest)                                             | Will require OAuth scopes + contract review                                                                       | Block go-live until DPA reviewed; retention automation required before enablement.                                                                          |
| Compliance Evidence Archive              | Vendor agreements, DPIA artifacts, audit emails (manual uploads)                       | Contact names (PD), email addresses (PD), signatures (PD), contractual terms (CBD)                                                                           | Git repo `docs/compliance/evidence/` (encrypted at rest via platform controls)                                        | 3 years post contract termination                                                              | Demonstrate regulatory due diligence & audits (legal obligation)                     | Repo access limited to compliance + manager; no sharing outside org                                               | Need checksum process + offboarding checklist for superseded documents.                                                                                     |
| Feedback & Risk Logs                     | Markdown updates under `feedback/` directory                                           | Contributor names (PD), status notes (CBD), vendor ticket IDs (CBD)                                                                                          | Git repo `feedback/`                                                                                                  | 18 months rolling                                                                              | Track compliance execution & risk communication (legitimate interest)                | Same repo ACL as codebase; rely on Git history audit                                                              | Add quarterly scrub to remove aged PII and link to evidence folder when closing items.                                                                      |

---

## Data Flow Notes

- **Shopify → HotDash**: Queries executed server-side with app access token; responses written to Prisma `DashboardFact`. No replication to Supabase today. Facts returned to React Router loaders for tile rendering.
- **Chatwoot → HotDash**: Conversations/messages retrieved per page, truncated to latest six messages. Stored facts include message excerpts and customer names. Operator actions push replies/tags back to Chatwoot and log decisions locally + Supabase.
- **Supabase Memory**: When configured, `logDecision` and analytics services mirror data to Supabase tables `decision_log` and `facts`. Service key scoped to those tables per `docs/runbooks/secret_rotation.md`.
- **Google Analytics MCP**: Currently mocked; production flow will POST date ranges to MCP host and ingest aggregated session metrics. No end-user identifiers transmitted.
- **OpenAI API via LlamaIndex**: Planned for CX tile suggestions; prompts assembled from Chatwoot excerpts and documentation embeddings. Ensure prompt builder redacts customer PII before transit and logs prompt fingerprints without raw content.
- **AI Logging/Index Builds**: Regression runs invoke `scripts/ai/log-recommendation.ts`, which writes NDJSON + JSON detail files under `packages/memory/logs/build/`; index rebuilds run `scripts/ai/build-llama-index.ts`, which wipes and recreates `packages/memory/indexes/operator_knowledge/`. Configure build pipeline to purge log files older than 30 days and capture metadata hashes for each new index.

---

## Retention Controls & Required Actions

1. Implement scheduled purge job for Prisma `DashboardFact` records older than 30 days (Shopify + GA) and 14 days for Chatwoot transcripts; mirror deletion to Supabase if replication added.
2. Add automated cleanup of expired Shopify sessions and revoke corresponding tokens via Shopify Admin API.
3. Define Supabase retention policy (SQL TTL or scheduled function) to delete `decision_log` entries older than 12 months and `facts` older than 180 days.
4. Document operator analytics collection in privacy notice and provide opt-out for GA/analytics tracking before MCP go-live.
5. Conduct DPIA covering Chatwoot transcript handling and planned OpenAI/LlamaIndex usage; capture in `docs/compliance/`.
6. Add retention validation for compliance evidence (3-year keep, purge + checksum record on sunset) and quarterly scrub of `feedback/` entries older than 18 months.

---

## Risk & Mitigation Tracker

- Track implementation status in `feedback/compliance.md` (see latest entry).
- Evidence (purge scripts, policy approvals, DPIA) must be stored under `docs/compliance/evidence/` once generated.

## Audit update 2025-10-11

- AI retention audit: artifacts/compliance/ai_retention_audit_2025-10-11.md
- Findings: see artifacts/compliance/ai_retention_audit_2025-10-11.json
- Blockers: tooling-only review; deeper validation may require jq/python; no infra touched.
